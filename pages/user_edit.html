<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원 정보 수정</title>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>

<body>
    <header>
        <a href="../index.html">홈으로</a>
    </header>

    <main>
        <h1>회원 정보 수정</h1>
        <form id="user-edit-form">
            <label for="name">이름:</label>
            <input type="text" id="name" name="name" required><br><br>

            <label for="email">이메일:</label>
            <input type="email" id="email" name="email" required><br><br>

            <label for="address">주소:</label>
            <input type="text" id="address" name="address" required>
            <button type="button" id="postcode-button">우편번호 찾기</button>

            <h2>내가 보유한 술</h2>
            <div id="owned-liquors"></div>

            <h2>좋아하는 술</h2>
            <div id="liked-liquors"></div>

            <h2>싫어하는 술</h2>
            <div id="disliked-liquors"></div>

            <button type="submit">수정하기</button>
        </form>
        <p id="message"></p>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const token = localStorage.getItem('access_token');
            const decodedToken = jwt_decode(token);
            const id = decodedToken.user_id;

            try {
                const response = await fetch(`http://localhost:8000/api/v1/accounts/${id}/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (response.ok) {
                    const userData = await response.json();

                    document.getElementById('name').value = userData.name;
                    document.getElementById('email').value = userData.email;
                    document.getElementById('address').value = userData.address;
                } else {
                    throw new Error('회원 정보를 불러오는 데 실패했습니다.');
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
            }

            const form = document.getElementById('user-edit-form');
            form.addEventListener('submit', async function (e) {
                e.preventDefault();

                const name = document.getElementById('name').value;
                const email = document.getElementById('email').value;
                const address = document.getElementById('address').value;

                try {
                    const response = await fetch(`http://localhost:8000/api/v1/accounts/${id}/`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: name,
                            email: email,
                            address: address
                        })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        document.getElementById('message').textContent = '회원 정보가 수정되었습니다.';
                    } else {
                        document.getElementById('message').textContent = result.message || '수정에 실패했습니다.';
                    }
                } catch (error) {
                    console.error('Error updating user data:', error);
                }
            });
            document.getElementById('postcode-button').addEventListener('click', function () {
                new daum.Postcode({
                    oncomplete: function (data) {
                        // 선택한 주소 정보를 주소 입력 필드에 설정
                        document.getElementById('address').value = data.address;
                    }
                }).open();
            });
        });

    </script>
</body>

</html>